#!/usr/bin/env bash
set -x

vcfile="DISTINFO"
srcdir="$1"

if [ -z "$srcdir" ]; then
    echo "Source directory path required" >&2
    exit 1
fi

if [ ! -f "$srcdir/CMakeLists.txt" ]; then
    echo "Not a cmake source directory: $srcdir" >&2
    exit 1
fi

if [ -f "$srcdir/DISTINFO" ]; then
    vcfile="$srcdir/DISTINFO"
fi

if [ -f "$vcfile" ]; then
    read -r VERSION COMMIT BRANCH <<< $(<${vcfile})
else
    if git --version &>/dev/null; then
        VERSION=$(git describe --dirty --abbrev=7)
        COMMIT=$(git rev-parse HEAD)
        BRANCH=$(git rev-parse --abbrev-ref HEAD)
    else
        echo "Git not found. Using default version values." >&2
    fi
fi

if [ -z "$VERSION" ]; then
    VERSION="unknown"
fi

if [ -z "$COMMIT" ]; then
    COMMIT="unknown"
fi

if [ -z "$BRANCH" ]; then
    BRANCH="unknown"
fi

cat << EOF > version.h
#ifndef HSTCAL_VERSION_H
#define HSTCAL_VERSION_H
#define VERSION "$VERSION"
#define COMMIT "$COMMIT"
#define BRANCH "$BRANCH"
#endif // HSTCAL_VERSION_H
EOF

cat << EOF > "$vcfile"
$VERSION
$COMMIT
$BRANCH
EOF

printf "$VERSION"
